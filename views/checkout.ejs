<%- include('./partials/header',) %>
<div
  class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 pt-24 px-4"
>
  <div
    class="max-w-md w-full bg-white p-8 rounded-2xl shadow-xl border border-gray-200"
  >
    <h2 class="text-3xl font-extrabold mb-6 text-center text-gray-800">
      üõí Checkout
    </h2>
    

    <form id="checkout-form" class="space-y-5">
      <!-- Amount Display -->
      <div class="flex flex-col gap-1">
        <label for="amount" class="text-gray-700 font-medium">Amount</label>
        <input
          id="amount"
          type="number"
          value="<%= totalBill %>"
          readonly
          class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-lg font-semibold text-gray-800 focus:outline-none cursor-not-allowed"
        />
      </div>

      <!-- Pay Button -->
      <button
        type="submit"
        class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg text-lg font-semibold shadow-md transition-all duration-200"
      >
        Pay ‚Çπ<%= totalBill %> with Razorpay
      </button>
    </form>

    <!-- Success Message -->
    <div
      id="success-alert"
      class="hidden mt-6 p-3 rounded-lg bg-green-100 text-green-700 text-center font-medium shadow-sm"
    ></div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- Razorpay SDK -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  const form = document.getElementById("checkout-form");
  const alertBox = document.getElementById("success-alert");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    const amount = document.getElementById("amount").value;

    try {
      const res = await fetch("/payment/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount }),
      });

      const data = await res.json();

      const options = {
        key: "<%= process.env.RAZORPAY_KEY_ID %>", // or use 'rzp_test_xxx' directly in dev
        amount: amount * 100, // Amount in paisa
        currency: "INR",
        name: "Scatch Store",
        description: "Scatch Order Payment",
        order_id: data.orderId, // From backend
        handler: function (response) {
          form.style.display = "none";
          alertBox.classList.remove("hidden");
          alertBox.textContent =
            "‚úÖ Payment Success! Payment ID: " + response.razorpay_payment_id;

          // OPTIONAL: Post this to /payment/verify
          fetch("/payment/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.verified) {
                window.location.href = data.redirectUrl;
              } else {
                alertBox.textContent = "‚ùå Payment verification failed.";
              }
            });
        },
        theme: {
          color: "#10b981",
        },
      };

      const rzp = new Razorpay(options);
      rzp.open();
    } catch (err) {
      console.error("Error creating order:", err);
      alert("‚ùå Something went wrong!");
    }
  });
</script>

<%- include('./partials/footer') %>
